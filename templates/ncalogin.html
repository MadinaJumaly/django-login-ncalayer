{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Login with Digital Signature</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="{% static 'js/jquery-3.6.0.min.js' %}"></script>
    <script src="{% static 'js/jquery.blockUI.js' %}"></script>
</head>
<body class="bg-light">

<div class="container d-flex align-items-center justify-content-center" style="min-height: 100vh;">
    <div class="card shadow p-4" style="width: 100%; max-width: 400px;">
        <h2 class="text-center mb-4">Login with EDS</h2>
        <div id="message" class="alert d-none" role="alert"></div>
        <button type="button" class="btn btn-success w-100" onclick="signAndLogin();">
            –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ –≠–¶–ü
        </button>
    </div>
</div>

<script>
const SOCKET_URL = 'wss://127.0.0.1:13579/';

function extractIIN(subjectDN) {
    if (!subjectDN || typeof subjectDN !== 'string') return null;
    const match = subjectDN.match(/SERIALNUMBER=(?:IIN)?(\d{12})/);
    return match ? match[1] : null;
}

function sendIINToBackend(iin) {
    console.log("üì® –û—Ç–ø—Ä–∞–≤–ª–µ–Ω IIN:", iin);
    fetch("/api/ncalayer-login/", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ iin: iin })
    })
    .then(response => response.json())
    .then(data => {
        console.log("‚úÖ –û—Ç–≤–µ—Ç –æ—Ç Django:", data);
        if (data.success) {
            window.location.href = data.redirect_url || "/dashboard/";
        } else {
            alert("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: " + (data.error || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞"));
        }
    })
    .catch(err => alert("–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: " + err));
}

function signAndLogin() {
    const socket = new WebSocket(SOCKET_URL);

    socket.onopen = () => {
        const request = {
            module: "kz.gov.pki.knca.commonUtils",
            method: "getKeyInfo",
            args: ["PKCS12"]
        };
        socket.send(JSON.stringify(request));
        console.log("üì° –ó–∞–ø—Ä–æ—Å getKeyInfo –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ NCALayer");
    };

    socket.onmessage = (event) => {
    const result = JSON.parse(event.data);
    console.log("üü° –û—Ç–≤–µ—Ç –æ—Ç NCALayer:", result);

    if (result.code !== "200" || !result.responseObject) {
        console.warn("‚è≥ –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π –∏–ª–∏ –Ω–µ–ø–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç ‚Äî –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º.");
        return;
    }

    const { subjectDn, certNotBefore, certNotAfter } = result.responseObject;

    if (!subjectDn) {
        alert("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å subjectDN –∏–∑ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞.");
        return;
    }

    const iin = extractIIN(subjectDn);
    if (!iin) {
        alert("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å –ò–ò–ù –∏–∑ subjectDN.");
        return;
    }

    if (!certNotBefore || !certNotAfter) {
        alert("‚ùå –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞—Ç—ã –¥–µ–π—Å—Ç–≤–∏—è (certNotBefore / certNotAfter).");
        return;
    }

    const issued = new Date(Number(certNotBefore));
    const expires = new Date(Number(certNotAfter));
    const today = new Date();

    console.log("üìÖ –î–∞—Ç–∞ –≤—ã–ø—É—Å–∫–∞:", issued, "–ò—Å—Ç–µ–∫–∞–µ—Ç:", expires, "–°–µ–≥–æ–¥–Ω—è:", today);

    if (today < issued || today > expires) {
        alert(`‚õî –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞: ${issued.toLocaleDateString()} ‚Äî ${expires.toLocaleDateString()}`);
        return;
    }

    sendIINToBackend(iin);
};
}
</script>

</body>
</html>

